<!doctype html>
<html>

<body onload="webpageLoaded()">
    
    <div id="menubar">
        <h1>Fire Emblem: Three Houses - Skill Requirement Calculator</h1>
        <select id="characterSelector" onchange="changedCharacter()">
            <option value = "bylethm">Byleth (M)</option>
            <option value = "bylethf">Byleth (F)</option>
        </select>
    </div>

    <div id="characterinfo">
        <h2 id="characterName">Byleth (M)</h2>
        
        <img src="resources/characterportraits/bylethm.png" id="characterPortrait" alt="Byleth (M)" width="100" height = "100">
        
        <div id="abilitytable">
            <h3>Desired Abilities</h3>
            <table>
                <tr>
                    <td><select id="abilitySelector0" onchange="changedAbility(0)"></select></td>
                    <td><img id="abilityIcon0" width = "25" height = "25"></td>
                </tr>
                <tr>
                    <td><select id="abilitySelector1" onchange="changedAbility(1)"></select></td>
                    <td><img id="abilityIcon1" width = "25" height = "25"></td>
                </tr>
                <tr>
                    <td><select id="abilitySelector2" onchange="changedAbility(2)"></select></td>
                    <td><img id="abilityIcon2" width = "25" height = "25"></td>
                </tr>
                <tr>
                    <td><select id="abilitySelector3" onchange="changedAbility(3)"></select></td>
                    <td><img id="abilityIcon3" width = "25" height = "25"></td>
                </tr>
                <tr>
                    <td><select id="abilitySelector4" onchange="changedAbility(4)"></select></td>
                    <td><img id="abilityIcon4" width = "25" height = "25"></td>
                </tr>
            </table>
        </div>
        
        <div id="skilltable">
            <h3>Minimum Skill Levels</h3>
            <table>
                <tr>
                    <td><img src="resources/skillicons/sword.png" alt="Sword" width="25" height = "25"></td>
                    <td id="swordSkillRank">A+</td>
                </tr>
                <tr>
                    <td><img src="resources/skillicons/lance.png" alt="Lance" width="25" height = "25"></td>
                    <td id="lanceSkillRank">A+</td>
                </tr>
                <tr>
                    <td><img src="resources/skillicons/axe.png" alt="Axe" width="25" height = "25"></td>
                    <td id="axeSkillRank">A+</td>
                </tr>
                <tr>
                    <td><img src="resources/skillicons/bow.png" alt="Bow" width="25" height = "25"></td>
                    <td id="bowSkillRank">A+</td>
                </tr>
                <tr>
                    <td><img src="resources/skillicons/brawling.png" alt="Brawling" width="25" height = "25"></td>
                    <td id="brawlingSkillRank">A+</td>
                </tr>
                <tr>
                    <td><img src="resources/skillicons/reason.png" alt="Reason" width="25" height = "25"></td>
                    <td id="reasonSkillRank">A+</td>
                </tr>
                <tr>
                    <td><img src="resources/skillicons/faith.png" alt="Faith" width="25" height = "25"></td>
                    <td id="faithSkillRank">A+</td>
                </tr>
                <tr>
                    <td><img src="resources/skillicons/authority.png" alt="Faith" width="25" height = "25"></td>
                    <td id="authoritySkillRank">A+</td>
                </tr>
                <tr>
                    <td><img src="resources/skillicons/heavyarmor.png" alt="Heavy Armor" width="25" height = "25"></td>
                    <td id="heavyArmorSkillRank">A+</td>
                </tr>
                <tr>
                    <td><img src="resources/skillicons/riding.png" alt="Riding" width="25" height = "25"></td>
                    <td id="ridingSkillRank">A+</td>
                </tr>
                <tr>
                    <td><img src="resources/skillicons/flying.png" alt="Flying" width="25" height = "25"></td>
                    <td id="flyingSkillRank">A+</td>
                </tr>
            </table>
        </div>
    </div>

</body>

<script>

/* CONSTANTS */
// Name of file containing character data
const CHARACTER_FILE = "characters.json";

// Name of file containing class data
const CLASS_FILE = "classes.json";

// Name of file containing ability data
const ABILITY_FILE = "abilities.json";

// Numeric values of letter skill ranks
const RANK_VALUES = {
    "e":  0,
    "e+": 1,
    "d":  2,
    "d+": 3,
    "c":  4,
    "c+": 5,
    "b":  6,
    "b+": 7,
    "a":  8,
    "a+": 9,
    "s":  10,
    "s+": 11,
};

// Placeholder text when no ability is selected
const NO_ABILITY = "-----";


/* VARIABLES */
// Table of character data.  Not an array because
// character names are alphabetized in dropdown and
// may not be in order as original JSON array.
var characters;

// Array of class data.
var classes;

// Array of ability data.
var abilities;


/* FUNCTIONS */
// Load a JSON data file
function loadFromJSON(path, dataCallback, namesCallback)
{
    let request = new XMLHttpRequest();
    request.onreadystatechange = function() {
        if ((this.readyState == 4) && (this.status == 200 || this.status == 0))
        {
            let array = JSON.parse(this.responseText);
            
            let names = [];
            let data = {};
            array.forEach(function(obj) {
                data[obj.name] = obj;
                names.push(obj.name);
            });

            dataCallback(data);

            if (namesCallback)
            {
                names.sort();
                namesCallback(names);
            }
        }
    }
    request.open("GET", path, true);
    request.send();
}

// Build list of values for a select object
function buildSelectorContent(values)
{
    let content = "";
    values.forEach(function(value) {
        content += "<option value=\"" + value + "\">" + value + "</option>\n";
    });
    return content;
}

function setCharacters(characterData)
{
    characters = characterData;
}

// Update character selector
function updateCharacterSelector(characterNames)
{
    document.getElementById("characterSelector").innerHTML = buildSelectorContent(characterNames);
}

function setClasses(classData)
{
    classes = classData;
}

function setAbilities(abilityData)
{
    abilities = abilityData;
}

// Update ability selectors
function updateAbilitySelectors(abilityNames)
{
    let content = buildSelectorContent(abilityNames);
    let i;
    for (i = 0; i < 5; i++)
    {
        document.getElementById("abilitySelector" + i).innerHTML = content;
    }
}

// Initialize the page
function webpageLoaded()
{
    // Initialize character, class, and ability data
    loadFromJSON(CHARACTER_FILE, setCharacters, updateCharacterSelector);
    loadFromJSON(CLASS_FILE, setClasses);
    loadFromJSON(ABILITY_FILE, setAbilities, updateAbilitySelectors);
}

// Get the name of the character currently selected
function getSelectedCharacterName()
{
    let selector = document.getElementById("characterSelector");
    return selector.options[selector.selectedIndex].text;
}

// Update currently displayed character name
function updateCharacterName(name)
{
    document.getElementById("characterName").innerHTML = name;
}

// Update currently displayed character portrait
function updateCharacterPortrait(character)
{
    let portraitFilename = character.portraitFilename || character.name.toLowerCase();
    document.getElementById("characterPortrait").src = "resources/characterportraits/" + portraitFilename + ".png";
}

// Change character portrait and character data
function changedCharacter()
{
    let name = getSelectedCharacterName();
    let character = characters[name];
    updateCharacterName(name);
    updateCharacterPortrait(character);
    // TODO: Update allowed skills
    // TODO: Clear selected skills
}

// Get name of ability selected by specified ability selector
function getSelectedAbilityName(n)
{
    let selector = document.getElementById("abilitySelector" + n);
    return selector.options[selector.selectedIndex].text;
}

// Update specified ability icon image
function updateAbilityIcon(n, ability)
{
    let iconFilename = ability.iconFilename || ability.name.toLowerCase();
    document.getElementById("abilityIcon" + n).src = "resources/abilityicons/" + iconFilename + ".png";
}

// Calculate the minimum skill requirements for an ability
function getAbilitySkillRequirements(ability)
{
    if (typeof(ability.skillRequirement) !== 'undefined')
    {
        return ability.skillRequirement;
    }
    else if (typeof(ability.classRequirement) !== 'undefined')
    {
        // TODO: Calculate minimum requirements among all possible classes
        //       Not currently necessary, but maybe in the future
        return classes[ability.classRequirement[0]].skillRequirements;
    }

    return {};
}

// Update minimum skill requirement text objects
function updateSkillRequirements()
{
    let minimumSkillRequirements = {
        "sword": "e",
        "lance": "e",
        "axe": "e",
        "bow": "e",
        "brawling": "e",
        "reason": "e",
        "faith": "e",
        "authority": "e",
        "heavyArmor": "e",
        "riding": "e",
        "flying": "e"
    };

    // Calculate minimum requirements among all skills
    let i;
    for (i = 0; i < 5; i++)
    {
        let abilityName = getSelectedAbilityName(i);
        if (abilityName != NO_ABILITY)
        {
            // TODO: Check if ability is budding talent FIRST (e.g. for Jeritza)

            let abilityRequirements = getAbilitySkillRequirements(abilities[abilityName]);
            Object.keys(abilityRequirements).forEach(function(key) {
                if (RANK_VALUES[abilityRequirements[key]] > RANK_VALUES[minimumSkillRequirements[key]])
                {
                    minimumSkillRequirements[key] = abilityRequirements[key];
                }
            });
        }
    }

    // TODO: Special per-character Authority requirements

    // Update skill requirement fields
    Object.keys(minimumSkillRequirements).forEach(function(key) {
        let requirement = minimumSkillRequirements[key];
        if (requirement == "e")
            requirement = "";
        document.getElementById(key + "SkillRank").innerHTML = requirement.toUpperCase();
    });
}

// Change ability icon and update required skill calculations
function changedAbility(n)
{
    let ability = abilities[getSelectedAbilityName(n)];
    updateAbilityIcon(n, ability);
    updateSkillRequirements();
}


</script>

</html>























